#!/bin/bash
set -euo pipefail

SESSION_FILE="agents/session.md"
TODO_FILE="agents/todo.md"

# Fail if todo.md does not exist
if [ ! -f "$TODO_FILE" ]; then
  echo "Error: $TODO_FILE does not exist" >&2
  exit 1
fi

# Fail if session.md already exists and is not empty template
if [ -f "$SESSION_FILE" ]; then
  # Check if session has any non-template content (non-empty sections)
  if grep -qv "^#\|^$\|^\*\*.*\*\*$" "$SESSION_FILE" | grep -q .; then
    echo "Error: $SESSION_FILE exists with content. Shelve first or manually clear." >&2
    exit 1
  fi
fi

# Extract content before first --- separator
awk '/^---$/ {exit} {print}' "$TODO_FILE" > "$SESSION_FILE"

# Remove extracted content from todo.md (keep everything after first ---)
awk 'BEGIN {found=0} /^---$/ {found=1; next} found {print}' "$TODO_FILE" > "$TODO_FILE.tmp"
mv "$TODO_FILE.tmp" "$TODO_FILE"

echo "Restored top item from $TODO_FILE to $SESSION_FILE"
