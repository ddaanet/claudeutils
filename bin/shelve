#!/bin/bash
set -euo pipefail

SESSION_FILE="agents/session.md"
TODO_FILE="agents/todo.md"
TEMPLATE_FILE="agents/session.template.md"

# Fail if session.md does not exist
if [ ! -f "$SESSION_FILE" ]; then
  echo "Error: $SESSION_FILE does not exist" >&2
  exit 1
fi

# Error if session.md contains separator
if grep -q "^---$" "$SESSION_FILE"; then
  echo "Error: $SESSION_FILE contains --- separator" >&2
  exit 1
fi

# Create todo.md if necessary
if [ ! -f "$TODO_FILE" ]; then
  echo "# Todo" > "$TODO_FILE"
  echo "" >> "$TODO_FILE"
fi

# Prepend session.md to todo.md with separator
{
  cat "$SESSION_FILE"
  echo ""
  echo "---"
  echo ""
  cat "$TODO_FILE"
} > "$TODO_FILE.tmp"

mv "$TODO_FILE.tmp" "$TODO_FILE"

# Reset session.md to template
cp "$TEMPLATE_FILE" "$SESSION_FILE"

echo "Shelved session to $TODO_FILE"
