# Project Configuration

Project-level configuration decisions for Claude Code, models, skills, and development environment.

## .Memory Index Pruning

### Growth + Consolidation Model

**Memory index append-only:**

**Decision Date:** 2026-02-01

**Decision:** No active pruning. Soft limit (100 entries) triggers consolidation of related entries into domain summaries, not deletion.

**Options considered:**
- A) No pruning, just growth — simple but index could become noisy
- B) Redundancy-based (remove when fragment is @-imported) — circular: index catalogs ALL knowledge
- C) Staleness-based (remove after N cycles without relevance) — requires metadata tracking, learnings aren't ephemeral
- D) Coverage-based (replace granular entries with domain summaries) — natural consolidation pattern

**Chosen:** A — append-only, no pruning, no consolidation, no limit.

**Rationale:**
- Each entry provides keyword-rich discovery surface for on-demand knowledge — removal loses ambient awareness
- Consolidation into domain summaries kills keyword matching (e.g., "Sandbox patterns" won't trigger when agent works on `prepare-runbook.py`)
- Soft limits cause the same failure as learnings.md: agents treat them as hard caps and aggressively prune
- Token cost is modest: 200 entries × ~25 tokens ≈ 5000 tokens (acceptable for always-loaded context)
- Growth is naturally bounded by consolidation rate (~5-10 entries/session)

**Impact:** memory-index.md header updated (append-only), consolidation-patterns.md updated, no changes to /remember skill logic.

## .Claude Code Rule Files

### Rule Files for Context Injection

**Rule files pattern:**

**Decision Date:** 2026-01-27

**Decision:** Use `.claude/rules/` with `paths` frontmatter for automatic context injection when editing domain-specific files.

**Rationale:**
- Documentation-only enforcement (CLAUDE.md tables) relies on model memory/attention - unreliable
- Hooks cannot detect skill loading state (only see tool inputs, not conversation context)
- Rule files with path prefixes provide automatic, hierarchical context injection

**Implementation:**
- `.claude/rules/skill-development.md` → `.claude/skills/**/*`
- `.claude/rules/hook-development.md` → `.claude/hooks/**/*`
- `.claude/rules/agent-development.md` → `.claude/agents/**/*`
- `.claude/rules/command-development.md` → `.claude/commands/**/*`

**Limitations:**
- Rule files provide passive reminders, not enforcement
- Models can still ignore rule context (requires compliance)
- Trade-off accepted: Better discoverability than CLAUDE.md bloat, but not foolproof

**Impact:**
- Improved discoverability of pre-edit requirements
- Automatic context loading when editing domain files
- Removed 13 lines of Pre-Edit Checks table from CLAUDE.md

## .Model Terminology

### Premium/Standard/Efficient Naming

**Premium standard efficient:**

**Decision Date:** 2026-01-27

**Decision:** Use "premium/standard/efficient" terminology for model tiers instead of "T1/T2/T3".

**Rationale:**
- T3 terminology ambiguous: Could mean "tier 3" (lowest) or "T-3" (third from top)
- Premium/standard/efficient clearly communicates capability hierarchy
- Aligns with cost and performance expectations

**Mapping:**
- Premium = Opus (architecture, complex design)
- Standard = Sonnet (general work, planning)
- Efficient = Haiku (execution, simple edits)

**Impact:**
- Clear model selection guidance in delegation
- No ambiguity in documentation and skill instructions
- Easier for users to understand model choices

## .Skill Discovery

### Multi-Layer Discovery Pattern

**Skill discovery layers:**

**Decision Date:** 2026-02-01

**Decision:** Skills require multiple discovery layers, not just good internal documentation.

**Anti-pattern:** Build well-documented skill and assume agents will find it ("build it and they will come")

**Correct pattern:** Surface skills via 4 discovery layers:
1. CLAUDE.md fragment or always-loaded context
2. Path-triggered `.claude/rules/` entry
3. In-workflow reminders in related skills
4. Directive skill description

**Rationale:** Agents only see skill listing descriptions and always-loaded context. Internal skill docs are invisible until invoked.

**Example:** opus-design-question skill had 248-line docs but zero external visibility — agents asked user instead of consulting it. Fixed with 4-layer approach.

**Impact:** Ensures skills are discoverable and used appropriately.

## .Agent Development

### Agent Frontmatter YAML Validation

**Agent frontmatter multiline:**

**Decision Date:** 2026-02-01

**Decision:** Agent frontmatter YAML must use multi-line syntax (`|`) for descriptions containing examples.

**Anti-pattern:**
```yaml
description: Short description
<example>...</example>
```

**Correct pattern:**
```yaml
description: |
  Short description with examples
  <example>...</example>
```

**Rationale:** YAML parsers treat unindented content after `description:` as new fields. Invalid YAML prevents agent registration. Multi-line string syntax (`|`) makes examples part of description value.

**Impact:** Prevents agent registration failures due to invalid YAML.

## .Symlink Management

### Symlink Persistence

**Symlinks after formatters:**

**Decision Date:** 2026-02-01

**Decision:** Verify symlinks after operations that reformat files.

**Anti-pattern:** Assume symlinks in `.claude/hooks/` persist across tool operations

**Correct pattern:** Verify symlinks after `just dev`, `ruff format`, or similar formatters

**Rationale:** Formatters follow symlinks and may replace them with reformatted copies. `just dev` did this to both hook .py files.

**Impact:** Use `just sync-to-parent` to restore symlinks after formatting operations.

## .Shell Environment

### Heredoc Sandbox Compatibility

**Heredocs in sandbox:**

**Decision Date:** 2026-02-01 (SOLVED)

**Problem:** Heredocs broken in sandbox mode — zsh uses `TMPPREFIX` (not `TMPDIR`) for heredoc temp files. Default `/tmp/zsh` is outside sandbox allowlist.

**Solution:** `export TMPPREFIX="${TMPDIR:-/tmp}/zsh"` in `agent-core/configs/claude-env.sh` (sourced by `.envrc`)

**Rationale:** Claude Code sandbox sets TMPDIR but not TMPPREFIX for zsh.

**Status:** Resolved in agent-core configuration.

**Impact:** Heredocs work correctly in sandbox mode.

## .Command-Line Parsing

### Flags Are Exact Tokens

**Flags are exact tokens:**

**Decision Date:** 2026-02-04

**Decision:** Flags are exact tokens (`--commit`), not prose containing flag-like words.

**Anti-pattern:** Parsing `/handoff describe commit` as having `--commit` flag (substring match).

**Correct pattern:** User prose after command is guidance for the skill, not flags. When ambiguous, assume no flag.

**Rationale:** Flags are CLI syntax; prose is user guidance. Substring matching leads to false positives.

**Impact:** Clear separation between flags and prose arguments.

## .Project Structure

### Root Marker for Scripts

**Root marker for scripts:**

**Decision Date:** 2026-02-04

**Decision:** Use `CLAUDE.md` as project root marker in `find_project_root()`.

**Anti-pattern:** Using `agents/` as project root marker.

**Rationale:** Subdirectories may contain their own `agents/` folders (e.g., `agent-core/agents/`), causing scripts to stop at wrong level.

**Impact:** Scripts correctly identify project root regardless of subdirectory structure.
