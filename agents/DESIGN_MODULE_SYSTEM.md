# Module System Design Document

**Status**: Design complete, awaiting implementation planning
**Last Updated**: 2025-12-21
**Design Authority**: Opus (claude-opus-4-5-20251101)

---

## Executive Summary

Restructure agent instruction files from monolithic role files to composable module system. Goals: reduce token costs (especially Opus planning output), enable reuse of cross-cutting concerns, provide target-appropriate wording (strong vs weak models), and maintain budget constraint of ≤150 total rules.

**Key innovation**: Semantic source files + generated variants per model class, with module-specific expansion ratios based on conceptual complexity.

---

## Requirements

### Core Constraints

- **Rule count limit**: ≤150 total user rules (Claude system prompt: ~50, leaving 150)
- **Token cost optimization**: Minimize Opus input/output tokens for planning work
- **Self-contained roles**: No plan/task-specific instructions in role files
- **Context caching**: Plans loaded by user, not referenced in "BEFORE STARTING" sections
- **Target-appropriate wording**: Concise for strong models, explicit for weak models

### Current System

**Files**:
- 6 roles: `planning.md`, `code.md`, `lint.md`, `refactor.md`, `execute.md`, `remember.md`
- 2 skills: `commit.md`, `handoff.md`
- 1 master: `AGENTS.md` (project overview, communication patterns, tool batching)

**Terminology**:
- **Role file** (e.g., `planning.md`): Defines agent behavior mode
- **Plan artifact** (e.g., `PLAN.md`): Task instructions created by planning/refactor roles
- **Skill file**: Action-triggered rules (commit before git commit, handoff before session end)

**Current state**: All files generated by Opus. Prose-heavy for strong models, itemized with ⚠️ symbols for weak models.

### Target State

- **Reusable modules**: Cross-cutting concerns (tool batching, checkpoint obedience, communication patterns)
- **Selective project context**: Planning needs full context, code needs data model only, lint/execute minimal
- **Priority tiering**: Rules distributed across document positions leveraging primacy/recency bias
- **Version control**: Both semantic sources and generated variants tracked
- **Rebuild tracking**: Makefile + sentinels keyed by model ID
- **Module sources**: Natural language, current Opus-generated files as initial sources

### Specific Requirements

1. **Remove "BEFORE STARTING" sections**: Plans loaded by user for context caching
2. **Factor checkpoint instructions**: Planning role inserts checkpoints in PLAN.md, code role obeys them
3. **Split project context**: Modules for overview, data model, commands (selective inclusion)
4. **Rebuild commit.md**: Currently haiku-optimized, needs semantic source
5. **AGENTS.md scope**: Fallback for non-role-primed agents only (communication + tool batching)
6. **Role-specific recipes**: Include in role files; generic recipes in AGENTS.md/README.md
7. **Different expansion needs**: Agent classes require different rule counts for same semantic module

---

## Verified Research Findings

### Rule Format
[Effect of Selection Format on LLM Performance (arXiv 2025)](https://arxiv.org/html/2503.06926): Bullet points outperform prose for task adherence due to pretraining corpus characteristics. However, connected ideas requiring context benefit from paragraph format.

### Model Capabilities
[Claude Model Family (Anthropic)](https://www.anthropic.com/news/claude-3-family):
- **Haiku**: Needs precise, scoped, bite-sized tasks. Quick but shallow with elaborate prompts.
- **Sonnet**: Handles clear prompts well. Balanced for general tasks.
- **Opus**: Can handle and benefit from very detailed/complex prompts. Catches nuances others miss.

### Position Bias (Critical)
[Serial Position Effects of LLMs (2024)](https://arxiv.org/html/2406.15981v1): LLMs exhibit **strong primacy bias** (beginning matters most) and recency bias. Middle content has weakest influence ("lost in the middle" phenomenon). [Primacy exploitation research](https://arxiv.org/html/2507.13949) confirms this pattern.

**Implication**: Current `remember.md` states "recency bias means later content gets more attention" - this is **incorrect**. Tier 1 (critical) rules should be at START (primacy position), not end.

### Context Loading
[Effective Context Engineering for AI Agents (Anthropic)](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents): LLMs only read explicitly provided context. No learned behavior to load additional files.

**Implication**: Role-primed agents won't load AGENTS.md unless explicitly instructed. No wasted rule needed to prevent loading.

### 20/60/20 Tiering
User claims research basis. [ResearchGate: The 20-60-20 Rule](https://www.researchgate.net/publication/270824843_The_20-60-20_rule) found, but is organizational change management, not LLM prompting. Opus assessment: treat as reasonable heuristic, not empirically validated for LLMs.

---

## Design Decisions

### 1. Module Taxonomy

**Cross-Cutting Modules** (universal behaviors):
- `communication.mod` - Stop patterns, unexpected state handling, wait for instruction
- `tool-batching.mod` - Parallel tool calls, efficiency patterns
- `checkpoint-obedience.mod` - Following plan checkpoints (factored from code/execute roles)

**Project Context Modules** (selective inclusion):
- `context-overview.mod` - Project purpose, architecture summary
- `context-datamodel.mod` - Key entities, relationships, schemas
- `context-commands.mod` - Build, test, deploy commands

**Workflow Modules** (role-specific behaviors):
- `tdd-cycle.mod` - Red-green-refactor methodology
- `plan-creation.mod` - Checkpoint insertion, plan structure
- `plan-adherence.mod` - Checkpoint following, scope discipline
- `code-quality.mod` - Testing requirements, PR standards
- `memory-management.mod` - Documentation patterns, tiering rules

**Skill Modules** (on-demand, token-cost exempt):
- `commit.skill` - Git commit workflow
- `handoff.skill` - Agent transition protocol

**Rationale**: Separation enables selective composition. Cross-cutting modules apply universally; project context splits allow planning roles to load full context while lint/execute roles load minimal. Checkpoint factorization reduces duplication across planning (INSERT) and code (OBEY) roles.

### 2. Format Recommendations

Based on research findings:

| Content Type | Format | Rationale |
|--------------|--------|-----------|
| Discrete rules | Bullets | arXiv 2025: bullets outperform prose for task adherence |
| Connected concepts | Prose paragraph | Same research: linked ideas need cohesion |
| Critical rules | ⚠️-prefixed items | Visual salience for weak models |
| Examples | Indented code blocks | Pattern matching for all model classes |

**Position optimization** (serial position effects):
- **Tier 1 rules**: Document START (primacy bias)
- **Tier 3 rules**: Document END (recency bias)
- **Tier 2 rules**: Middle (weakest position, contains most rules)

**Format per module type**:
- Cross-cutting: Pure itemized (discrete behaviors)
- Workflow: Hybrid (conceptual intro + itemized rules)
- Context: Prose (connected project knowledge)
- Skills: Itemized with examples (procedural)

### 3. Adaptation Strategy

**Three-tier model class system**:

| Class | Model Examples | Characteristics |
|-------|----------------|-----------------|
| Strong | Opus | Prose-tolerant, inference-capable |
| Standard | Sonnet | Clear prompts, moderate expansion |
| Weak | Haiku | Explicit steps, ⚠️ markers required |

**Mechanism: Semantic source + generated variants**

```
modules/src/tdd-cycle.semantic.md   # Version-controlled source
modules/gen/tdd-cycle.strong.md    # Generated by Opus
modules/gen/tdd-cycle.standard.md  # Generated by Opus
modules/gen/tdd-cycle.weak.md      # Generated by Opus
```

**Expansion ratios** (fixed per-module, not uniform):

```yaml
expansion_sensitivity: low | medium | high | explicit

# Maps to strong:standard:weak ratios:
low:      1x : 1.2x : 1.5x   # Concrete rules (tool-batching)
medium:   1x : 2x   : 3x     # Mixed content (plan-adherence)
high:     1x : 3x   : 5x     # Conceptual (tdd-cycle)
explicit: 1x : 1x   : 1.2x   # Already weak-optimized (communication)
```

**Generation approach**:
- Semantic source stores meaning-complete representation with expansion metadata
- Expansion ratios enable deterministic budget planning
- Opus generates variants with target rule count as hard constraint
- Makefile tracks model ID for rebuild triggers
- Manual review for weak expansions (highest fidelity risk)

**Rationale**: Hybrid approach balances version-controlled intent with cached adaptations. Pure template markers fragment readability. Pure on-demand wastes tokens. Module-specific ratios acknowledge varying conceptual complexity.

**Trade-off accepted**: Some weak variants may be under-expanded for complex concepts. Prioritizes budget predictability over perfect coverage.

### 4. Configuration Schema

```yaml
# roles/planning.role.yaml
role: planning
target_class: strong  # strong|standard|weak
rule_budget: 45       # Role-specific cap

modules:
  cross_cutting:
    - communication: tier1
    - tool-batching: tier2

  project_context:
    - context-overview: tier2
    - context-datamodel: tier2
    - context-commands: tier3

  workflow:
    - plan-creation: tier1
    - tdd-cycle: tier2

# Module inclusion conditions
conditionals:
  plan-adherence: false  # Planning creates plans, doesn't follow them
  checkpoint-obedience: false

# Output structure
sections:
  - ROLE_IDENTITY       # Role definition
  - CRITICAL_RULES      # Tier 1 (primacy position)
  - GUIDELINES          # Tier 2
  - PREFERENCES         # Tier 3 (recency position)
  - CONTEXT             # Project context last

# Budget overflow handling
overflow_strategy: warn  # truncate_tier3|warn|fail
```

**Schema elements**:
- `target_class`: Determines which generated variant to include
- `rule_budget`: Per-role cap; script validates combined total ≤150
- `modules`: Grouped by type, each with priority tier assignment (contextual, not fixed)
- `conditionals`: Role-specific module inclusion/exclusion
- `sections`: Output structure template (tier-to-position mapping)
- `overflow_strategy`: Behavior when role exceeds budget

**Priority assignment rationale**: Contextual per-role, not fixed per-module. Example: checkpoint-obedience is Tier 1 for code role (must follow), Tier 2 for execute role (less critical).

### 5. Generation Pipeline

**Stage 1: Source Authoring (Manual)**
- Create/update `modules/src/*.semantic.md`
- Track authoring model in frontmatter
- Include `expansion_sensitivity` and optional `weak_expansion_notes`

**Stage 2: Variant Generation (Opus, cached)**
- Input: semantic.md + target_class
- Output: `modules/gen/*.{strong,standard,weak}.md`
- Trigger: source change OR model ID change
- Target rule count calculated from expansion ratio
- Opus prompt includes target count as hard constraint
- Validation rejects variants exceeding target ±10%

**Stage 3: Role Composition (Script)**
- Input: role.yaml + generated variants
- Process:
  - Select variants by target_class
  - Apply tier→section mapping
  - Validate rule count (itemize, count ≤150)
- Output: `roles/gen/planning.md`

**Stage 4: Validation (Script)**
- Rule count per role ≤ budget
- Combined rules ≤ 150
- Required modules present
- No orphan modules (unused by any role)

**Makefile sentinel pattern**:
```makefile
modules/gen/%.strong.md: modules/src/%.semantic.md .model-id
    opus-generate --class=strong $< > $@

.model-id: FORCE
    echo $(OPUS_MODEL_ID) | cmp -s - $@ || echo $(OPUS_MODEL_ID) > $@
```

**Rationale**: Sentinel tracks model ID; regenerates when Anthropic releases new Opus version. Both sources and generated files version-controlled (generated files rarely change, valuable for review/diff).

### 6. Example Module Structure

**Semantic source format**:

```markdown
# modules/src/checkpoint-obedience.semantic.md
---
author_model: claude-opus-4-5-20251101
semantic_type: workflow
expansion_sensitivity: high  # Weak needs significant expansion
weak_expansion_notes: |
  - Emphasize "STOP" with visual marker
  - Enumerate checkpoint recognition patterns
  - Provide explicit "do not" examples
  - Add consequence framing ("failure to stop causes...")
---

## Semantic Intent

Agent must follow plan checkpoints exactly. Each checkpoint represents
a stopping point for verification. Agent must not proceed past checkpoint
without explicit instruction. Checkpoints may contain tool restrictions
or output requirements.

## Key Behaviors

1. Stop at checkpoint boundary
2. Report checkpoint status
3. Await instruction before proceeding
4. Honor checkpoint-specific constraints
```

**Generated weak variant** (5x expansion for high sensitivity):

```markdown
## CHECKPOINT ADHERENCE

⚠️ STOP at every checkpoint marker in the plan
⚠️ DO NOT proceed past a checkpoint without user instruction
⚠️ Report completion status when reaching checkpoint

Checkpoint recognition:
- Lines starting with `## Checkpoint`
- Lines containing `[STOP]` marker
- Explicit "pause for review" instructions

When you reach a checkpoint:
1. Stop all work immediately
2. Report what was completed
3. Wait for user to say "continue" or provide new direction
4. Do not assume continuation

⚠️ Failure to stop at checkpoints causes scope creep and rework
```

---

## Implementation Plan Dependencies

### TODO: Test Expansion Quality

**Objective**: Validate that Sonnet and Opus can generate appropriate weak variants.

**Method**:
1. Select pilot module (suggest: checkpoint-obedience, high expansion sensitivity)
2. Create semantic source
3. Generate weak variant with Sonnet
4. Generate weak variant with Opus
5. Compare for: rule count accuracy, explicitness, haiku comprehension
6. Decide: Sonnet sufficient, or Opus required for quality?

**Impact**: Determines generation cost (Sonnet cheaper but may under-expand).

### TODO: Extract Current Rules to Semantic Sources

**Objective**: Convert existing Opus-generated role files into semantic sources.

**Method**:
1. Identify cross-cutting concerns in current files
2. Extract to semantic sources (infer expansion_sensitivity)
3. Create role configurations (which modules, what tiers)
4. Validate extracted modules cover all current rules

**Priority**: Must complete before implementation; establishes module inventory.

### TODO: Script Requirements

**Components needed**:
1. **Rule counter**: Itemize markdown, count rules (handle nested lists, prose paragraphs)
2. **Module composer**: Combine variants per role config, apply tier→section mapping
3. **Budget validator**: Check per-role and total rule counts
4. **Makefile integration**: Sentinel-based rebuild on source/model changes

**Language**: Python (project standard), integrate with existing `uv` setup.

### TODO: Migration Strategy

**Phases**:
1. Pilot module conversion (checkpoint-obedience)
2. Extract remaining modules from current files
3. Generate variants, validate quality
4. Compose new role files
5. Side-by-side testing (old vs new role files)
6. Cutover and archive old files

---

## Open Questions

1. **Expansion generator**: Sonnet sufficient or Opus required? (TEST NEEDED)
2. **Rule counting**: How to handle prose paragraphs vs itemized lists? (count paragraphs as N rules, or sentences, or semantic units?)
3. **Overflow handling**: Which strategy for budget overflow? (warn, truncate_tier3, fail)
4. **Commit.md rebuild**: Use as pilot module, or defer until system proven?
5. **AGENTS.md regeneration**: Include in pipeline, or manual maintenance?

---

## Design Decision Summary

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Module granularity | Semantic groupings, not per-rule | Enables meaningful composition; rule-level too fragmented |
| Format authority | Research-backed (bullets + position bias) | arXiv findings, serial position effects |
| Adaptation storage | Semantic + generated variants | Version-controlled intent + cached adaptations |
| Expansion ratios | Fixed per-module (sensitivity-based) | Budget predictability, acknowledges varying complexity |
| Priority system | Role-contextual assignment | Same module has different criticality per role |
| Skill handling | Standalone, weak variants only | On-demand loading; token cost irrelevant |
| AGENTS.md scope | Fallback only (communication + tool-batching) | Role-primed agents skip it per research |
| Tier distribution | Tier 1→start (primacy), Tier 3→end (recency), Tier 2→middle | Position bias exploitation |
| Rule counting | Script validates, LLM itemizes | Human oversight + automated enforcement |
| Both sources and generated files version controlled | Enables review, diff, rollback | Generated files rarely change, valuable context |

---

## References

- [Effect of Selection Format on LLM Performance](https://arxiv.org/html/2503.06926)
- [Claude Model Family](https://www.anthropic.com/news/claude-3-family)
- [Serial Position Effects of LLMs](https://arxiv.org/html/2406.15981v1)
- [Exploiting Primacy Effect](https://arxiv.org/html/2507.13949)
- [Effective Context Engineering for AI Agents](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents)
- [ResearchGate: The 20-60-20 Rule](https://www.researchgate.net/publication/270824843_The_20-60-20_rule)

---

## Document History

| Date | Change | Author |
|------|--------|--------|
| 2025-12-21 | Initial design from Opus consultation | opus-4-5, sonnet-4-5 |
