# Exploration Report: Agent Definition and Prolog/Skill Reference Patterns

**Date:** 2026-02-05

## Summary

Claudeutils defines agents and skills using a structured YAML frontmatter pattern with clear separation between metadata (frontmatter) and behavioral content (body). Plan-specific task agents are generated by `prepare-runbook.py` from baseline templates, inheriting execution protocols while receiving runbook-specific context. Skills define entry points with declarative tool constraints and dependencies. The codebase demonstrates two key patterns: (1) baseline agent templates that are inherited and combined with plan context, and (2) quiet execution pattern where agents write detailed results to files and return only filepaths.

## Key Findings

### 1. Agent Frontmatter Structure

**Format:** YAML between `---` markers at the top of agent files.

**Required fields:**
- `name` — Unique agent identifier (used for selection and context injection)
- `description` — Brief prose explaining agent purpose (user-visible)
- `model` — Execution model: `haiku`, `sonnet`, or `opus`
- `color` — UI hint for agent visualization (optional)
- `tools` — Array of allowed tools for this agent

**Example from `/Users/david/code/claudeutils/.claude/agents/statusline-parity-task.md` (lines 1-7):**
```yaml
---
name: statusline-parity-task
description: Execute statusline-parity steps from the plan with plan-specific context.
model: haiku
color: cyan
tools: ["Read", "Write", "Edit", "Bash", "Grep", "Glob"]
---
```

**Example from `/Users/david/code/claudeutils/agent-core/agents/vet-agent.md` (lines 1-7):**
```yaml
---
name: vet-agent
description: Review-only vet agent (writes review to file, returns filepath). Use when caller has context to apply fixes (Tier 1/2 direct/lightweight delegation). For orchestration where no agent has fix context, use vet-fix-agent instead.
model: sonnet
color: cyan
tools: ["Read", "Write", "Bash", "Grep", "Glob", "AskUserQuestion"]
---
```

### 2. Skill Definition Frontmatter

Skills use similar YAML frontmatter with additional metadata fields for skill-specific behavior.

**Fields used:**
- `name` — Skill identifier (user invokes as `/name`)
- `description` — Purpose statement (prose)
- `allowed-tools` — Tools available to skill (comma-separated list or bash pattern)
- `user-invocable` — Boolean (`true`/`false`) indicating if user can call directly
- `model` — Execution model when skill invokes sub-agents
- `requires` — Dependencies on other resources
- `outputs` — Artifacts skill produces

**Example from `/Users/david/code/claudeutils/agent-core/skills/design/SKILL.md` (lines 1-5):**
```yaml
---
description: Entry point for implementation tasks. Triages complexity (simple/moderate/complex), then produces design documents for complex jobs or routes to planning for moderate ones.
allowed-tools: Task, Read, Write, Bash, Grep, Glob, WebSearch, WebFetch
user-invocable: true
---
```

**Example from `/Users/david/code/claudeutils/agent-core/skills/plan-tdd/SKILL.md` (lines 1-11):**
```yaml
---
name: plan-tdd
description: Create TDD runbook with RED/GREEN/REFACTOR cycles from design document
model: sonnet
allowed-tools: Task, Read, Write, Edit, Skill, Bash(mkdir:*, agent-core/bin/prepare-runbook.py, echo:*|pbcopy)
requires:
  - Design document from /design (TDD mode)
  - CLAUDE.md for project conventions (if exists)
outputs:
  - TDD runbook at plans/<feature-name>/runbook.md
  - Ready for prepare-runbook.py processing
---
```

**Tool constraints pattern:** Bash can be constrained to specific commands using parenthetical syntax:
- `Bash(mkdir:*, agent-core/bin/prepare-runbook.py, echo:*|pbcopy)` — Only allows mkdir, prepare-runbook.py, and echo with pipe to pbcopy

**Handoff skill example from `/Users/david/code/claudeutils/agent-core/skills/handoff/SKILL.md` (lines 1-6):**
```yaml
---
name: handoff
description: This skill should be used when the user asks to "handoff", "update session", "end session", or mentions switching agents. Updates session.md with completed tasks, pending work, blockers, and learnings for seamless agent continuation. NOT for Haiku model orchestrators - use /handoff-haiku instead.
allowed-tools: Read, Write, Edit, Bash(wc:*), Skill
user-invocable: true
---
```

### 3. Plan-Specific Task Agent Pattern

Plan-specific agents are created by `prepare-runbook.py` for each runbook (TDD or general).

**Creation logic** (`/Users/david/code/claudeutils/agent-core/bin/prepare-runbook.py`, lines 444-496):

1. **Derives runbook name** from parent directory: `plans/foo/runbook.md` → `foo`
2. **Selects baseline template** based on runbook type:
   - TDD runbooks: `/Users/david/code/claudeutils/agent-core/agents/tdd-task.md`
   - General runbooks: `/Users/david/code/claudeutils/agent-core/agents/quiet-task.md`
3. **Generates new frontmatter** with plan-specific metadata:
   ```python
   # Lines 487-496
   def generate_agent_frontmatter(runbook_name, model='haiku'):
       """Generate frontmatter for plan-specific agent."""
       return f"""---
   name: {runbook_name}-task
   description: Execute {runbook_name} steps from the plan with plan-specific context.
   model: {model}
   color: cyan
   tools: ["Read", "Write", "Edit", "Bash", "Grep", "Glob"]
   ---
   """
   ```
4. **Combines frontmatter + baseline body** to create `.claude/agents/{runbook_name}-task.md`

**Result:** Example in `/Users/david/code/claudeutils/.claude/agents/consolidation-task.md` (plan-specific, auto-generated) inherits full baseline from `tdd-task.md` with updated frontmatter.

**Naming convention:** `{plan-name}-task.md` allows auto-selection during orchestration (plan name matches agent name).

### 4. Baseline Agent Templates

Baseline templates (`quiet-task.md`, `tdd-task.md`) define execution protocols that plan-specific agents inherit by substituting the frontmatter.

**Quiet Task baseline** (`/Users/david/code/claudeutils/agent-core/agents/quiet-task.md`):
- **Purpose:** General-purpose task execution agent
- **Frontmatter** (lines 1-7): Name, description, model (haiku), tools
- **Body sections** (lines 10-132):
  - Role: Clear execution directive ("do what has been asked")
  - Execution behavior: When to proceed vs. when to stop
  - Output format: Success reports (brief) vs. error reports (diagnostic)
  - Tool usage: Guidance on specialized tools over Bash
  - Constraints: File creation, git operations, communication rules
  - Response protocol: Execute → Verify → Report

**TDD Task baseline** (`/Users/david/code/claudeutils/agent-core/agents/tdd-task.md`):
- **Purpose:** TDD cycle execution (RED/GREEN/REFACTOR discipline)
- **Body sections** (lines 14-300+):
  - Role: TDD cycle agent with stop conditions
  - RED phase protocol: Write test, verify failure
  - GREEN phase protocol: Write minimal implementation, verify pass
  - REFACTOR phase protocol: Format, lint, commit, post-commit sanity check
  - Stop conditions: RED passes unexpectedly, GREEN blocked, precommit failures
  - Tool usage constraints: Bash strict mode with absolute paths
  - Verification protocol: Phase-by-phase checks
  - Response protocol: Status codes (success, quality-check, blocked, error, refactoring-failed)

**Vet Agent** (`/Users/david/code/claudeutils/agent-core/agents/vet-agent.md`, lines 1-7):
- **Frontmatter** (lines 1-7): Sonnet model, review-focused description
- **Body sections** (lines 10-353):
  - Role: Code review specialization
  - Review protocol: Validate document type, determine scope, gather changes, analyze, write report, return result
  - File operations: Read (analysis), Write (report only), no edits
  - Scope handling: Ask user if not provided (AskUserQuestion tool)
  - Report structure: Summary, issues (critical/major/minor), requirements validation, outline validation, positive observations, recommendations, next steps

### 5. Quiet Execution Pattern

The quiet execution pattern separates computation from orchestrator communication: agents write detailed results to files and return only filepaths.

**Pattern definition** (`/Users/david/code/claudeutils/agent-core/agents/quiet-explore.md`, lines 58-74):

```markdown
### Return Value

After writing the report:
- **Success:** Return the filepath only (absolute or relative to working directory)
- **Failure:** Return error message with diagnostics

**Example success return:**
```
plans/design-workflow-enhancement/reports/explore-agent-patterns.md
```

**Example failure return:**
```
Error: Pattern "**/*.agent" matched no files
Details: Searched in /Users/david/code/claudeutils
Recommendation: Check pattern syntax or search path
```
```

**Success return format:** Filepath only, no summary or explanation.

**Failure return format:** Structured error with:
- Error: What failed
- Details: Error message or diagnostic info
- Context: What was being attempted
- Recommendation: What to do

**Report file locations:**
- Design phase: `plans/{name}/reports/explore-{topic}.md`
- Ad-hoc work: `tmp/explore-{topic}.md`
- Plan execution: `plans/{plan-name}/reports/{report-name}.md`

**Goal:** Keep orchestrator context lean (hundreds of tokens) while detailed results persist in files for inspection and downstream agents.

### 6. Agent Invocation Patterns

**Direct user invocation:** Skills registered as `user-invocable: true` are triggered by slash commands (`/design`, `/plan-tdd`, `/handoff`).

**Sub-agent delegation:** Skills invoke sub-agents using Task tool with explicit type:
```markdown
Task(subagent_type="quiet-explore")
Task(subagent_type="vet-agent")
Task(subagent_type="tdd-plan-reviewer", model="sonnet")
```

**Plan-specific agent selection:** Orchestrator auto-selects agents matching plan name (pattern: `{plan-name}-task.md` in `.claude/agents/`).

**Skill prolog:** Skills list `requires:` and `outputs:` to declare dependencies and artifacts:
- `requires: [Design document from /design, CLAUDE.md]`
- `outputs: [TDD runbook at plans/..., Ready for prepare-runbook.py]`

## Patterns

### Prolog Pattern (Skills and Agents)

**YAML frontmatter acts as prolog** specifying:
- **Metadata:** Name, model, color
- **Constraints:** Tools (allowed-tools in skills, tools in agents)
- **Dependencies:** `requires:` lists what skill needs
- **Outputs:** `outputs:` declares what skill produces
- **Behavior hints:** `description:` guides agent selection

**Constraint syntax:**
- Unrestricted: `tools: ["Read", "Write", "Bash"]`
- Pattern-restricted: `allowed-tools: Bash(mkdir:*, prepare-runbook.py)`
- Multi-constraint: `Bash(mkdir:*, agent-core/bin/prepare-runbook.py, echo:*|pbcopy)`

### Baseline Template Inheritance Pattern

1. **Baseline defines protocol:** `quiet-task.md` and `tdd-task.md` contain full behavioral content (Role, Execution Behavior, Output Format, Tool Usage, Constraints, Response Protocol)
2. **Script generates frontmatter:** `prepare-runbook.py` creates runbook-specific metadata
3. **Combine into plan-specific agent:** New file at `.claude/agents/{plan-name}-task.md` gets generated frontmatter + baseline body
4. **Agent discovered by name:** Orchestrator finds agent by matching plan name to agent name

**Benefits:** Protocol consistency (all TDD agents follow same RED/GREEN/REFACTOR steps), reduced duplication, centralized update point.

### Quiet Execution Pattern

1. **Agent writes results to file:** Reports go to `plans/{plan}/reports/` or `tmp/`
2. **Agent returns filepath only:** Success = filename, Failure = structured error message
3. **Orchestrator reads report if needed:** Separate read operation with minimal context load
4. **Two-phase communication:**
   - Phase 1: Execution agent produces detailed artifact (file)
   - Phase 2 (optional): Summary agent reads and distills if human communication needed

**Benefits:** Orchestrator context remains lean, detailed diagnostics available for inspection, downstream agents can reference reports without re-reading orchestrator transcripts.

### Tool Constraints Pattern

Skills and agents declare tools in frontmatter with three styles:

1. **Unrestricted:** `tools: ["Read", "Write", "Bash"]` — Full access
2. **Command-restricted:** `allowed-tools: Bash(mkdir:*, prepare-runbook.py)` — Only listed bash commands
3. **Multi-level:** `allowed-tools: Task, Read, Write, Skill, Bash(mkdir:*, agent-core/bin/prepare-runbook.py, echo:*|pbcopy)` — Mix of unrestricted and restricted tools

**Rationale:** Constraints prevent misuse (e.g., agent can't run destructive git commands), enforce tool preferences (Read over cat), and document what operations are expected.

## Absolute File Paths

### Agent Definition Files
- **Baseline TDD agent:** `/Users/david/code/claudeutils/agent-core/agents/tdd-task.md`
- **Baseline quiet task agent:** `/Users/david/code/claudeutils/agent-core/agents/quiet-task.md`
- **Vet agent:** `/Users/david/code/claudeutils/agent-core/agents/vet-agent.md`
- **Vet-fix agent:** `/Users/david/code/claudeutils/agent-core/agents/vet-fix-agent.md`
- **Quiet explore agent:** `/Users/david/code/claudeutils/agent-core/agents/quiet-explore.md`
- **Design vet agent:** `/Users/david/code/claudeutils/agent-core/agents/design-vet-agent.md`
- **Plan-specific agents (generated):** `/Users/david/code/claudeutils/.claude/agents/{name}-task.md`

### Skill Definition Files
- **Design skill:** `/Users/david/code/claudeutils/agent-core/skills/design/SKILL.md`
- **Plan TDD skill:** `/Users/david/code/claudeutils/agent-core/skills/plan-tdd/SKILL.md`
- **Plan adhoc skill:** `/Users/david/code/claudeutils/agent-core/skills/plan-adhoc/SKILL.md`
- **Handoff skill:** `/Users/david/code/claudeutils/agent-core/skills/handoff/SKILL.md`
- **Handoff haiku skill:** `/Users/david/code/claudeutils/agent-core/skills/handoff-haiku/SKILL.md`
- **Commit skill:** `/Users/david/code/claudeutils/agent-core/skills/commit/SKILL.md`
- **Orchestrate skill:** `/Users/david/code/claudeutils/agent-core/skills/orchestrate/SKILL.md`
- **Vet skill:** `/Users/david/code/claudeutils/agent-core/skills/vet/SKILL.md`
- **Remember skill:** `/Users/david/code/claudeutils/agent-core/skills/remember/SKILL.md`
- **Reflect skill:** `/Users/david/code/claudeutils/agent-core/skills/reflect/SKILL.md`

### Generation Script
- **Prepare runbook script:** `/Users/david/code/claudeutils/agent-core/bin/prepare-runbook.py`

## Gaps

1. **Symlink management for agents/skills:** The exploration did not find `.claude/agents/` symlink patterns pointing to `agent-core/agents/`. CLAUDE.md mentions `just sync-to-parent` creates symlinks, but specific structure unclear.

2. **Hook prolog patterns:** Exploration focused on agents and skills. Hook definitions (`.claude/hooks/`, `.claude/settings.json`) not examined. Hook frontmatter patterns likely different.

3. **Sub-agent context injection:** How `prepare-runbook.py` injects plan-specific context (Common Context section) into generated agent bodies not detailed in this exploration. Script reads `.claude/agents/{plan-name}-task.md` after generation, suggesting post-hoc assembly.

4. **Agent selection algorithm:** How Claude Code selects which agent to load when user invokes a skill or `/orchestrate` command not documented in files examined. Presumed to be name-matching (`{plan-name}-task.md` for plan `{plan-name}`) but not verified.

5. **Tool constraint enforcement:** How allowed-tools constraints are validated at runtime (when tools are invoked) not visible in sampled files. Likely handled by hook layer or platform layer.
