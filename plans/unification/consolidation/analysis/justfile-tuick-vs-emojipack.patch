--- /Users/david/code/tuick/justfile	2026-01-03 15:34:21
+++ /Users/david/code/emojipack/justfile	2026-01-15 14:57:17
@@ -1,224 +1,313 @@
-# Tuicker project commands
+[private]
+_ := require("uv")
 
-# Display available recipes
-[group('user')]
-help:
-    @just --list --unsorted
+# Import shared recipes from agent-core
+# Using absolute path for testing (will use relative path with actual submodule)
+import '/Users/david/code/agent-core/fragments/justfile-base.just'
 
-# Install tuick using uv tool
-[group('user')]
-install:
-    uv tool install --refresh-package tuick file://.
+# Variables required by imported recipes
+SRC_DIR := "src"
+TEST_DIR := "tests"
+VENV := ".venv"
 
-# Common variables
+# Display available recipes
+# Commented out - using imported help recipe from agent-core instead
+# [default]
+# [group('general')]
+# help:
+#     @just --list --unsorted
 
-[private]
-_run-dev := 'uv run --dev'
-[private]
-_python-dirs := "src tests scripts"
-[private]
-_pytest-opts := "--no-header --tb=short"
+# Test local recipe execution: project-specific recipe alongside imported ones
+[group('testing')]
+test-local:
+    @echo "emojipack project-specific recipe executed (works alongside imported recipes)"
 
-# Bash definitions
+# Generate Emoji Pack
+[group('general')]
+build:
+    mkdir -p build
+    cd build; uv run emojipack generate
+    cd build; uv run emojipack generate --macos
 
-[private]
-_bash-defs := '''
-run_dev="''' + _run-dev + '''"
-python_dirs="''' + _python-dirs + '''"
-full_diff=''' + full-diff + ''';
-COMMAND="''' + style('command') + '''"
-NORMAL="''' + NORMAL + '''"
-safe () { "$@" || status=false; }
-end-safe () { ${status:-true}; }
-show () { echo "$COMMAND$*$NORMAL"; }
-visible () { show "$@"; "$@"; }
-report () { local s=$?; show "$@"; echo "$out"; return $s; }
-quiet () { out=$("$@" >&1) || report "$@"; }
-pytest-agent-filter () {
-    $full_diff && while read -r line
-    do [[ $line =~ ^===+\ FAILURES\ ===+$ ]] && break; done
-    cat
-}
-tuickf="tuick --format"
-'''
-# Pytest options.
-# Run with full-diff=true for full diffs.
+# Generate Emoji Pack and open with Alfred
+[group('general')]
+install: generate
+    open "build/Emoji Pack.alfredsnippets"
 
-full-diff := 'false'
-[private]
-_diff-limit-opt := ' -o truncation_limit_lines=7'
-[private]
-_pytest-diff-opt := if full-diff == 'true' { ' --verbose' } else { ' --quiet' + _diff-limit-opt }
-[private]
-_pytest-agent-opts := _pytest-opts + " -p no:icdiff" + _pytest-diff-opt
+[group('general')]
+generate *ARGS:
+    cd build; uv run emojipack generate {{ ARGS }}
 
-# Development workflow: check, test, ARGS passed to pytest
-[group('dev')]
-dev *ARGS: _fail_if_claudecode compile
-    #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }} {{ _check-body }}
-    safe visible $run_dev $tuickf -- pytest {{ _pytest-opts }} {{ ARGS }}
-    end-safe
 
-# Agent workflow: check, test with minimal output, ARGS passed to pytest
-[group('agent')]
-agent *ARGS: agent-compile
+# Compare generated pack with Joel's pack
+[group('general')]
+compare: generate
     #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }} {{ _agent-check-body }}
-    safe quiet {{ _run-dev }} pytest {{ _pytest-agent-opts }} {{ ARGS }} \
-    | pytest-agent-filter \
-    || $full_diff || echo 'For full diff: just full-diff=true agent"'
-    end-safe && echo OK
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    if [ ! -f data/joel.alfredsnippets ]
+    then do-command curl --location --output data/joel.alfredsnippets \
+        "https://joelcalifa.com/blog/alfred-emoji-snippet-pack/Emoji%20Pack.alfredsnippets"
+    fi
+    do-command uv run emojipack compare data/joel.alfredsnippets "build/Emoji Pack.alfredsnippets"
 
-# Clean build files
-[group('dev')]
-clean:
-    rm -rf .venv */__pycache__ */*/__pycache__ build dist list */*.so */*/*.so
+# Hack to perform string interpolation on variables. Render the content of
+# the variables in a just subprocess, passing in the is_dependency() value.
+# In the subprocess, is_dependency() is always false.
+# Usage: {{ functions }} {{ is_dependency() }} {{ inner }}
+inner := "false"
+functions := 'load-funcs () { source <(just _functions $2 $1); }; load-funcs '
 
-# Clean non-build caches and run files
-[group('dev')]
-clean-cache:
-    rm -rf .dmypy.json .mypy_cache .pytest_cache .ruff_cache
-
-# Fail if CLAUDECODE is set
-[no-exit-message]
+# Common functions for all recipes
+[group('internal')]
 [private]
-_fail_if_claudecode:
-    #!/usr/bin/env bash -euo pipefail
-    if [ "${CLAUDECODE:-}" != "" ]; then
-        echo -e '{{ style("error") }}â›”ï¸ Denied: use agent recipes{{ NORMAL }}'
-        exit 1
+_functions isdep inner:
+    #!/bin/cat
+    # exit-with: run command and exit with original status
+    exit-with () { local s=$?; "$@"; exit $s; }
+    # style-* : set text style.
+    style-command () { echo -n "{{ style('command') }}"; }
+    style-warning () { echo -n "{{ style('warning')}}"; }
+    style-error () { echo -n "{{ style('error') }}"; }
+    style-okay () { echo -en '\033[1;92m'; }
+    style-reset () { echo -ne "{{ NORMAL }}"; }
+    # echo-style STYLE ARGS... : Print ARGS in with STYLE.
+    echo-style () {
+        # Uncomment following line to ignore style if stdout is not a tty.
+        # [ ! -t 1 ] && { shift; echo "$*"; return; }
+        "style-$1"; shift
+        echo -n "$*"; style-reset; echo
+    }
+    do-command () {
+        local cmd=""
+        for arg in "$@"; do
+            cmd+=$(printf "%q " "$arg")
+        done
+        echo-style command "${cmd% }" >&2
+        "$@"
+    }
+    okay () { echo-style okay "âœ… ${*:-OK}" >&2; }
+    warning () { echo-style warning "âš ï¸  $*" >&2; }
+    error () { echo-style error "âŒ ${*:-FAIL}" >&2; }
+    # No success or error output when running as dependency.
+    if {{ isdep }} || {{ inner }}
+    then okay () { :; }; error () { :; }
     fi
+    # add-status command ...: run command and add $? to status variable
+    # Can run multiple seqential commands, delaying failure.
+    add-status () { set +e; "$@"; (( status = ${status:-0} + $? )); set -e; }
+    # do-status: return the accumulated status
+    do-status () { return ${status:-0}; }
 
-_python_format := \
-"""-p '%E*** Error ' -p '%C  File "%f", line %l' -p '%C%m' -p '%Z'"""
-
-# Compile python files, quick test for valid syntax
-[group('dev')]
+# Display available styles
+[group('internal')]
 [private]
-compile:
+colors:
     #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }}
-    compile="python3 -m compileall -q $python_dirs"
-    show $run_dev $tuickf -- $compile
-    $run_dev $tuickf {{ _python_format }} -- $compile
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    echo "Inline styles:"
+    for x in command warning error okay reset
+    do style-$x; echo -n "$x "
+    dones
+    echo
+    echo "Line styles:"
+    do-command command
+    for x in warning error okay
+    do $x $x
+    done
 
-# Compile python files, with less output
+# Development workflow: test, check
+# Commented out - using imported dev recipe from agent-core instead
+# [group('developer')]
+# [no-exit-message]
+# dev:
+#     #!/usr/bin/env bash -euo pipefail
+#     {{ functions }} {{ is_dependency() }} {{ inner }}
+#     just inner=true check-compile || exit-with error
+#     add-status just inner=true test
+#     add-status just inner=true check
+#     do-status && okay "Development checks OK" || exit-with error
+
+python_dirs := "src tests"
+
+# Remove caches and build files
+[group('developer')]
+clean:
+    find {{ python_dirs }} -type d -name '__pycache__' | xargs rm -rf
+    rm -rf .*_cache .venv build
+
+# Agent workflow: minimal output version of dev
 [group('agent')]
 [no-exit-message]
-[private]
-agent-compile:
+agent:
     #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }}
-    quiet {{ _run-dev }} -m compileall -q {{ _python-dirs }}
+    # Do not reformat code in agent mode, to prevent desync with agent state.
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    quietly () {
+        style-command; echo -n "$1... "; shift
+        output=$("$@" >&1) \
+        && { style-okay; echo OK; style-reset; } \
+        || {
+            local s=$?
+            style-error; echo FAIL
+            style-reset; echo "${output}"
+            return $s
+        }
+    }
+    add-status quietly "Test suite" just inner=true agent-test
+    add-status quietly "Static analysis" just inner=true agent-check
+    add-status quietly "Code style" just inner=true agent-check-format
+    do-status && okay || exit-with error
 
-# Run test suite, ARGS passed to pytest
-[group('dev')]
-test *ARGS: _fail_if_claudecode
-    {{ _run-dev }} tuick --format -- pytest {{ _pytest-opts }} {{ ARGS }}
+# Run test suite
+# Commented out - using imported test recipe from agent-core instead
+# [group('developer')]
+# [no-exit-message]
+# test *ARGS:
+#     uv run --dev pytest --no-header {{ ARGS }}
 
-# Run test suite, with less output, ARGS passed to pytest
+# Run test suite in agent mode (less output)
 [group('agent')]
 [no-exit-message]
 agent-test *ARGS:
-    #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }}
-    quiet {{ _run-dev }} pytest {{ _pytest-agent-opts }} {{ ARGS }} \
-    | pytest-agent-filter \
-    && { {{ is_dependency() }} || echo OK; } \
-    || { $full_diff || echo 'For full diff: just full-diff=true agent-test';
-         false; }
+    @uv run --dev pytest --no-header --quiet --tb=short {{ ARGS }}
 
 # Static code analysis and style checks
-[group('dev')]
-check: _fail_if_claudecode compile
+# Commented out - using imported check recipe from agent-core instead
+# [group('developer')]
+# [no-exit-message]
+# check:
+#     #!/usr/bin/env bash -euo pipefail
+#     {{ functions }} {{ is_dependency() }} {{ inner }}
+#     # if inner=true, recipe is being run by dev recipe,
+#     if ! {{ inner }}
+#     then just inner=true check-compile || exit-with error
+#     fi
+#     add-status just inner=true check-format
+#     add-status just inner=true check-ruff
+#     add-status just inner=true check-types
+#     do-status && okay Static analysis and format checks passed \
+#     || exit-with error
+
+[private]
+[group('agent')]
+[no-exit-message]
+agent-check: agent-check-compile
     #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }} {{ _check-body }}
-    end-safe
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    add-status just inner=true agent-check-ruff
+    add-status just inner=true agent-check-types
+    do-status && okay || exit-with error
 
+# Check that all Python files compile
 [private]
-_check-body := '''
-    safe visible $run_dev $tuickf -- ruff format --check --quiet $python_dirs
-    safe visible $run_dev $tuickf -p "%E%f" -- docformatter --check $python_dirs
-    safe visible $run_dev $tuickf -- ruff check --quiet $python_dirs
-    safe visible $run_dev $tuickf -- mypy
-    safe visible $run_dev make -C agents check
-'''
+[group('developer')]
+[no-exit-message]
+check-compile:
+    #!/usr/bin/env bash -euo pipefail
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    do-command uv run -m compileall -q {{ python_dirs }} \
+    && okay || exit-with error
 
-# Report TODO, FIXME, XXX, HACK comments
-[group('dev')]
-todo:
-    {{ _run-dev }} ruff check --quiet --ignore ALL --select FIX \
-        {{ _python-dirs }}
-
-# Static code analysis and style checks, with less output
+# Check that all Python files compile (less output)
+[private]
 [group('agent')]
 [no-exit-message]
-agent-check: agent-compile
+agent-check-compile:
+    @uv run -m compileall -q {{ python_dirs }}
+
+# Ruff static analysis only
+[private]
+[group('developer')]
+[no-exit-message]
+check-ruff:
     #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }} {{ _agent-check-body }}
-    end-safe && { {{ is_dependency() }} ||  echo OK; }
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    do-command uv run --dev ruff check --quiet {{ python_dirs }} \
+    && okay "Ruff check passed" \
+    || exit-with error "Ruff check failed, try 'just ruff-fix' to fix"
 
+
+# Ruff static analysis only (less output)
 [private]
-_agent-check-body := '''
-    safe quiet $run_dev ruff format --check --quiet $python_dirs \
-    || { echo 'Try "just format"'; status=false; }
-    safe quiet $run_dev docformatter --check $python_dirs
-    safe quiet $run_dev ruff check --quiet --output-format=concise $python_dirs
-    safe quiet $run_dev mypy
-    safe quiet $run_dev make -C agents check
-'''
+[group('agent')]
+[no-exit-message]
+agent-check-ruff:
+    #!/usr/bin/env bash -euo pipefail
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    uv run --dev ruff check --quiet {{ python_dirs }} \
+    && okay || exit-with error "Ruff check failed, try 'just ruff-fix' to fix"
 
-# Ruff auto-fix
-[group('dev')]
-ruff-fix *ARGS:
-    {{ _run-dev }} ruff check --quiet --output-format=concise --fix \
-    {{ ARGS }} {{ _python-dirs }}
+# Ruff auto-fix (unsafe fixes enabled)
+# Commented out - using imported ruff-fix recipe from agent-core instead
+# [group('developer')]
+# [no-exit-message]
+# ruff-fix:
+#     #!/usr/bin/env bash -euo pipefail
+#     {{ functions }} {{ is_dependency() }} {{ inner }}
+#     do-command uv run --dev ruff check --fix --unsafe-fixes {{ python_dirs }} \
+#     && okay || exit-with error "Manual fix required"
 
-# Reformat code, fail if formatting errors remain
-[group('dev')]
-format:
+# Type checking with ty and mypy
+[group('developer')]
+[no-exit-message]
+check-types:
     #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }}
-    safe visible $run_dev ruff format $python_dirs
-    safe visible $run_dev ruff check --fix --unsafe-fixes --fix-only $python_dirs
-    safe visible $run_dev docformatter --in-place $python_dirs
-    end-safe
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    do-command uv run --dev ty check && (
+        do-command uv run --dev mypy \
+        || exit-with warning "mypy found issues that ty did not"
+    ) \
+    && okay "Type checks passed" \
+    || exit-with error "Type check failed, manual fix required"
 
-# Create release: tag, build tarball, upload to PyPI and GitHub
-[group('dev')]
-release bump='patch': _fail_if_claudecode dev
+# Type checking with ty and mypy (less output)
+[private]
+[group('agent')]
+[no-exit-message]
+agent-check-types:
     #!/usr/bin/env bash -euo pipefail
-    {{ _bash-defs }}
-    ERROR="{{ style('error') }}"
-    GREEN=$'\033[32m'  # ansi code for green
-    fail () { echo "${ERROR}$*${NORMAL}"; exit 1; }
-    git diff --quiet HEAD || fail "Error: uncommitted changes"
-    release=$(uv version --bump {{ bump }} --dry-run)
-    while read -re -p "Release $release? [y/n] " answer; do
-        case "$answer" in
-            y|Y) break;;
-            n|N) exit 1;;
-            *) continue;;
-        esac
-    done
-    visible uv version --bump {{ bump }}
-    version=$(uv version)
-    git add pyproject.toml uv.lock
-    visible git commit -m "ðŸ”– Release $version"
-    visible git push
-    tag="v$(uv version --short)"
-    git rev-parse "$tag" >/dev/null 2>&1 \
-    && fail "Error: tag $tag already exists"
-    visible git tag -a "$tag" -m "Release $version"
-    visible git push origin "$tag"
-    visible uv build
-    visible uv publish
-    visible gh release create "$tag" --title "Release $version" \
-        --generate-notes
-    echo "${GREEN}Release $tag complete${NORMAL}"
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    # ty prints annoying output on success, it can be disabled with -q, but
+    # that completely disables error reporting.
+    quietly () { out=$("$@" 2>&1) || exit-with echo "$out"; }
+    quietly uv run --dev ty check --output-format=concise && (
+        uv run --dev mypy \
+        || exit-with warning "mypy found issues that ty did not"
+    ) && okay || exit-with error
 
-# Find new multi-line expressions for line-counter analysis
+# Check code formatting
+[group('developer')]
+[no-exit-message]
+check-format:
+    #!/usr/bin/env bash -euo pipefail
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    add-status do-command uv run --dev ruff format --check {{ python_dirs }}
+    add-status do-command uv run --dev docformatter --check {{ python_dirs }}
+    do-status && okay "Format checks passed" \
+    || exit-with error "Format check failed, try 'just format' to fix"
+
+# Check code formatting (less output)
+[private]
 [group('agent')]
-agent-new-multi:
-    uv run --dev scripts/find_multiline_exprs.py
+[no-exit-message]
+agent-check-format:
+    #!/usr/bin/env bash -euo pipefail
+    {{ functions }} {{ is_dependency() }} {{ inner }}
+    add-status uv run --dev ruff format --quiet --check {{ python_dirs }}
+    add-status uv run --dev docformatter --check {{ python_dirs }}
+    do-status && okay \
+    || exit-with error "Format check failed, try 'just format' to fix"
+
+# Reformat code, fail if formatting errors remain
+# Commented out - using imported format recipe from agent-core instead
+# [group('developer')]
+# [no-exit-message]
+# format:
+#     #!/usr/bin/env bash -euo pipefail
+#     {{ functions }} {{ is_dependency() }} {{ inner }}
+#     add-status do-command uv run --dev ruff format {{ python_dirs }}
+#     add-status do-command \
+#         uv run --dev docformatter --in-place {{ python_dirs }}
+#     do-status && okay Code format OK || exit-with error Code format failed
+
+
