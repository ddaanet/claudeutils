# YAML Configuration Schema Design (agents/compose.yaml)

**Date**: 2026-01-19
**Based on**: Core module design, CLI design, emojipack pattern, design.md composition model
**Status**: Design artifact for Phase 3 Step 4
**Integration**: Configuration file format for `claudeutils compose` command

---

## Overview

The YAML configuration schema defines the structure for composition definitions. It serves as the contract between user intent (fragment assembly) and programmatic execution (compose() function).

### Design Principles

1. **YAML anchors for deduplication** - Reuse source paths without repetition
2. **Flat fragment list** - Order-preserving, explicit sequence
3. **Configuration-driven** - YAML is source of truth, CLI args override
4. **Required fields minimal** - Only `fragments` and `output` strictly required
5. **Optional enhancements** - Title, header adjustment, separator style, validation mode

### File Location

```
agents/compose.yaml          # Primary composition definition
agents/compose-*.yaml        # Alternate compositions (expanded, minimal, etc.)
```

---

## Complete Schema Definition

### Root Level

```yaml
# Required
fragments:                   # List[str] - Ordered fragment paths
  - path/to/fragment1.md
  - path/to/fragment2.md

output:                      # str - Output file path (relative or absolute)
  path/to/output.md

# Optional: Path source deduplication
sources:                     # Dict[str, str] - Path prefix mappings
  core: agent-core/fragments
  local: src/fragments
  custom: path/to/other

# Optional: Composition behavior
title:                       # str | null - Prepended markdown header
  "Document Title"

adjust_headers:              # bool - Increase all fragment headers by 1 level
  true

separator:                   # str - Fragment separator style
  "---"                      # Options: "---", "blank", "none"

validate_mode:               # str - Error handling for missing fragments
  "strict"                   # Options: "strict", "warn"

# Future extensions (not in Phase 3)
roles:                       # Dict[str, RoleDefinition] - Role templates
  role_name:
    title: "Role Title"
    fragments: [...]
    adjust_headers: true
```

### Full Type Specification

```python
# TypeScript-like notation for clarity
CompositionConfig = {
    # Required
    fragments: List[str],     # Non-empty list
    output: str,              # Non-empty string

    # Optional with defaults
    sources?: Dict[str, str],          # Default: {}
    title?: str | None,                # Default: None
    adjust_headers?: bool,             # Default: False
    separator?: "---" | "blank" | "none",  # Default: "---"
    validate_mode?: "strict" | "warn", # Default: "strict"

    # Future
    roles?: Dict[str, RoleDefinition],
}

RoleDefinition = {
    title: str,
    fragments: List[str],
    adjust_headers?: bool,
    separator?: str,
}
```

---

## Detailed Field Specifications

### `fragments` (Required)

**Type**: `List[str]`

**Purpose**: Ordered list of fragment file paths to compose.

**Constraints**:

- Must be non-empty list
- Paths can be relative (from config file directory) or absolute
- Paths can reference `sources` prefixes (e.g., `*core/file.md`)
- Order is preserved exactly (deterministic composition)
- Duplicate entries allowed (compose same file multiple times)

**Validation**:

- List length > 0 (fail: "fragments list is empty")
- Each element is string (fail: "fragment not string at index N")
- Path validation deferred to compose time (strict vs warn mode)

**Examples**:

```yaml
# Absolute paths
fragments:
  - /Users/david/docs/intro.md
  - /Users/david/docs/features.md

# Relative paths (from config directory)
fragments:
  - docs/intro.md
  - docs/features.md

# With anchors (see sources section)
fragments:
  - *core/communication.md
  - *local/rules.md
  - *core/footer.md

# Mixed
fragments:
  - agent-core/fragments/header.md
  - docs/intro.md
  - *custom/section.md
```

---

### `output` (Required)

**Type**: `str`

**Purpose**: Path to output file generated by composition.

**Constraints**:

- Non-empty string
- Relative (resolved from config directory) or absolute
- Parent directory created automatically if needed
- Existing file overwritten without prompt

**Validation**:

- Non-empty string (fail: "output is empty")
- String type (fail: "output not string")
- Path writeability checked at compose time

**Examples**:

```yaml
# Relative (common)
output: CLAUDE.md
output: docs/README.md
output: agents/role-orchestrator.md

# Absolute
output: /Users/david/projects/my-project/AGENTS.md

# Nested path (parent dirs created)
output: generated/docs/full-api.md
```

---

### `sources` (Optional)

**Type**: `Dict[str, str]`

**Purpose**: Path prefix mappings to reduce repetition in fragment list.

**Constraints**:

- Keys are identifiers (alphanumeric, underscore)
- Values are directory paths
- Used with YAML anchors for deduplication
- Not for variable substitution (use anchors)

**Pattern (YAML anchors)**:

```yaml
sources:
  core: &core agent-core/fragments
  local: &local src/fragments/

fragments:
  - *core/file1.md      # Expands to agent-core/fragments/file1.md
  - *local/file2.md     # Expands to src/fragments/file2.md
```

**Validation**:

- Dict\[str, str] if present
- Keys: alphanumeric + underscore only
- Values: non-empty strings (paths)

**Design notes**:

- Keys are **not used for path resolution** — YAML anchors handle that
- `sources` is purely for developer convenience (DRY principle)
- Recommended pattern: One anchor per source directory
- No variable substitution (YAML anchors are preferred)

**Example**:

```yaml
sources:
  core: &core agent-core/fragments
  roles: &roles src/fragments/roles
  local: &local .

fragments:
  - *core/AGENTS-framework.md
  - *core/communication.md
  - *roles/orchestrator-purpose.md
  - *local/project-specific.md
  - *core/footer.md
```

---

### `title` (Optional)

**Type**: `str | None`

**Purpose**: Markdown header to prepend to composed output.

**Default**: `None` (no title)

**Behavior**:

- If provided: written as `# {title}\n\n` at start of output
- If null or absent: skipped

**Constraints**:

- String if provided
- Content can include spaces, punctuation
- Interpreted as markdown (no escaping needed)

**Examples**:

```yaml
# With title
title: "Project Documentation"
# Outputs: # Project Documentation\n\n[fragments...]

# Without title (common for CLAUDE.md)
# output file starts with first fragment content
```

**Use cases**:

- Role files: `title: "Orchestrator Agent"`
- Documentation: `title: "API Reference"`
- Composed specifications: `title: "System Architecture"`
- CLAUDE.md: typically no title (fragments already have headers)

---

### `adjust_headers` (Optional)

**Type**: `bool`

**Purpose**: Increase all fragment header levels by 1 (h1→h2, h2→h3, etc.)

**Default**: `False`

**Behavior**:

- `true`: Calls `increase_header_levels(content, 1)` on each fragment
- `false`: Fragments used as-is
- Applied after fragment loading, before output

**Use cases**:

- Role files: Increase headers to nest under document title
- Included documentation: Prevent header level conflicts
- **NOT used** for flat CLAUDE.md composition

**Example**:

**Input** (`src/fragments/purpose.md`):

```markdown
# Purpose

Coordinate workflow between agents.

## Responsibilities

- Task delegation
- Error handling
```

**Config**:

```yaml
adjust_headers: true
```

**Output**:

```markdown
## Purpose

Coordinate workflow between agents.

### Responsibilities

- Task delegation
- Error handling
```

---

### `separator` (Optional)

**Type**: `"---" | "blank" | "none"`

**Default**: `"---"`

**Purpose**: Visual separator between fragments in output.

**Behavior**:

- `"---"`: Markdown horizontal rule: `\n---\n\n`
- `"blank"`: Blank line: `\n\n`
- `"none"`: No separator (fragments concatenated directly)
- Applied between each pair of consecutive fragments
- **Not applied** after last fragment

**Examples**:

**With `separator: "---"` (default)**:

```markdown
[fragment1 content]

---

[fragment2 content]

---

[fragment3 content]
```

**With `separator: "blank"`**:

```markdown
[fragment1 content]

[fragment2 content]

[fragment3 content]
```

**With `separator: "none"`**:

```markdown
[fragment1 content]
[fragment2 content]
[fragment3 content]
```

---

### `validate_mode` (Optional)

**Type**: `"strict" | "warn"`

**Default**: `"strict"`

**Purpose**: Error handling strategy for missing fragments.

**Behavior**:

**strict mode**:

- Pre-validate all fragments before writing
- Fail immediately if any fragment missing
- No partial output created
- Exit code: 2 (fragment error)

**warn mode**:

- Log warnings for missing fragments
- Continue with available fragments
- Partial output created
- Print summary: "Composed X of Y fragments"
- Exit code: 0 (success with warnings)

**Configuration**:

```yaml
# Strict (fail on missing) — recommended default
validate_mode: "strict"

# Warn (skip missing, log warnings) — for optional content
validate_mode: "warn"
```

**CLI override**:

```bash
claudeutils compose config.yaml --validate warn
```

---

## Validation Rules

### Load-time Validation (Schema)

Performed when loading YAML configuration:

```
1. File exists and readable
2. Valid YAML syntax
3. Required fields present: fragments, output
4. Fragment list non-empty (fail if empty)
5. Output non-empty string
6. Field types correct:
   - fragments: list
   - output: string
   - sources: dict (if present)
   - title: string or null
   - adjust_headers: boolean
   - separator: one of "---", "blank", "none"
   - validate_mode: one of "strict", "warn"
7. Unknown fields ignored (for forward compatibility)
```

**Error reporting** (fail immediately):

```
Example: "Configuration error: fragments list is empty"
Example: "Configuration error: Missing required field: output"
Example: "Configuration error: Invalid separator value: '-'"
```

### Compose-time Validation (Files)

Performed during composition:

**strict mode**:

```
1. Check all fragments exist before writing
2. Fail if any missing (FileNotFoundError)
3. List all missing files in error message
4. No partial output
```

**warn mode**:

```
1. Check each fragment as it's processed
2. Skip missing fragments with warning
3. Continue with available fragments
4. Summary: "Composed X of Y fragments"
```

---

## YAML Anchor Usage Pattern

### Purpose

Reduce path duplication using YAML anchors (`&anchor_name`) and aliases (`*anchor_name`).

### Syntax

```yaml
sources:
  core: &core agent-core/fragments      # Define anchor
  local: &local src/fragments

fragments:
  - *core/communication.md              # Use anchor
  - *local/project-rules.md
  - *core/footer.md
```

**How it works**:

1. `&core` creates an anchor pointing to string value `agent-core/fragments`
2. `*core` references that anchor, inserting the value
3. YAML expands `*core/communication.md` to `agent-core/fragments/communication.md`

### Benefits

- **DRY principle**: Define paths once, reference many times
- **Maintainability**: Update path in one place
- **Clarity**: Intent visible in `sources` section
- **No substitution logic needed**: Native YAML feature

### Pattern Examples

**Single source**:

```yaml
sources:
  core: &core agent-core/fragments

fragments:
  - *core/communication.md
  - *core/delegation.md
  - *core/footer.md
```

**Multiple sources**:

```yaml
sources:
  core: &core agent-core/fragments
  local: &local src/fragments/roles
  shared: &shared shared-lib/docs

fragments:
  - *core/header.md
  - *local/orchestrator-rules.md
  - *shared/architecture.md
  - *core/footer.md
```

**No anchors** (for simple cases):

```yaml
fragments:
  - agent-core/fragments/communication.md
  - agent-core/fragments/delegation.md
```

---

## Complete Schema Examples

### Example 1: Simple CLAUDE.md (agents mode)

**File**: `agents/compose.yaml`

```yaml
# Minimal configuration for CLAUDE.md generation
sources:
  core: &core agent-core/fragments

fragments:
  - *core/AGENTS-framework.md
  - *core/communication.md
  - *core/delegation.md
  - *core/tool-preferences.md
  - *core/hashtags.md

output: CLAUDE.md
```

**Properties**:

- No `title` (CLAUDE.md starts with framework)
- No `adjust_headers` (flat structure)
- Default separator (`---`)
- Default validation mode (`strict`)
- Uses anchors for DRY

**Generated output**:

- File: `CLAUDE.md` (at project root)
- Content: Framework + 5 sections with separators
- Total: \~30-40 KB

---

### Example 2: Role File (role mode)

**File**: `agents/compose.yaml`

```yaml
sources:
  core: &core agent-core/fragments
  roles: &roles src/fragments/roles

fragments:
  - *core/role-header.md
  - *roles/orchestrator-purpose.md
  - *roles/orchestrator-capabilities.md
  - *roles/orchestrator-constraints.md
  - *core/role-footer.md

output: agents/role-orchestrator.md
title: Orchestrator Agent
adjust_headers: true
separator: "---"
validate_mode: strict
```

**Properties**:

- Title: Prepended as `# Orchestrator Agent`
- Header adjustment: All fragment headers increased by 1 level
- Separator: Markdown horizontal rule between sections
- Strict mode: Fail if any fragment missing

**Input fragments**:

```
role-header.md:
  # Header Content
  Framework for role definitions

orchestrator-purpose.md:
  # Purpose
  Coordinate work between agents

orchestrator-capabilities.md:
  # Capabilities
  - Delegation
  - Error handling
```

**Generated output** (`agents/role-orchestrator.md`):

```markdown
# Orchestrator Agent

## Header Content
Framework for role definitions

---

## Purpose
Coordinate work between agents

---

## Capabilities
- Delegation
- Error handling

---

[footer content with adjusted headers]
```

---

### Example 3: Multi-project with Anchors

**File**: `agents/compose.yaml`

```yaml
sources:
  core: &core agent-core/fragments
  local: &local .
  project: &project src/fragments

fragments:
  # Core framework
  - *core/AGENTS-framework.md

  # Communication rules
  - *core/communication.md
  - *local/project-communication-addendum.md

  # Delegation patterns
  - *core/delegation.md
  - *project/model-selection-local.md

  # Tool preferences
  - *core/tool-preferences.md
  - *project/project-tool-rules.md

  # Project-specific
  - *local/special-considerations.md

  # Shared closing
  - *core/footer.md

output: CLAUDE.md
separator: "---"
validate_mode: warn
```

**Properties**:

- Mixes core, local, and project-specific fragments
- Anchors reduce path repetition
- Warn mode: Skip optional fragments if missing
- 9 fragments composed

**Pattern**:

- Core fragments provide foundation
- Local fragments (`&local`) for `.` (current dir) files
- Project fragments for structured source organization
- Flexibility: Add local overrides without breaking

---

### Example 4: Simple Without Anchors

**File**: `agents/compose-simple.yaml`

```yaml
# Minimal configuration without anchors
# Good for simple, single-source compositions

fragments:
  - agent-core/fragments/communication.md
  - agent-core/fragments/delegation.md
  - agent-core/fragments/tool-preferences.md

output: CLAUDE.md
```

**When to use**:

- Simple compositions (2-3 fragments)
- Single source directory
- Don't need DRY optimization yet
- Adding anchors later is easy

---

### Example 5: Multiple Configurations

**Directory structure**:

```
agents/
  compose.yaml              # Default (full)
  compose-minimal.yaml      # For distribution
  compose-expanded.yaml     # Extended version
```

**agents/compose-minimal.yaml**:

```yaml
fragments:
  - agent-core/fragments/AGENTS-framework.md
  - agent-core/fragments/communication.md
  - agent-core/fragments/delegation.md

output: dist/CLAUDE-minimal.md
validate_mode: strict
```

**agents/compose-expanded.yaml**:

```yaml
sources:
  core: &core agent-core/fragments
  local: &local .

fragments:
  - *core/AGENTS-framework.md
  - *core/communication.md
  - *local/project-rules-extended.md
  - *core/delegation.md
  - *core/tool-preferences.md
  - *core/hashtags.md

output: CLAUDE-expanded.md
```

**Usage**:

```bash
# Default composition
claudeutils compose agents/compose.yaml

# Minimal distribution
claudeutils compose agents/compose-minimal.yaml

# Expanded development version
claudeutils compose agents/compose-expanded.yaml --output docs/CLAUDE-extended.md
```

---

## Schema Validation Approach

### Two-Phase Validation

**Phase 1: Load-time (Schema)**

```
Location: load_config() function in compose.py
When: YAML parsing, before compose()
Output: Raise ValueError for schema violations
```

**Phase 2: Compose-time (Files)**

```
Location: compose() function in compose.py
When: Fragment processing
Output: Raise FileNotFoundError or log warnings
```

### Load-time Validation Implementation

```python
def load_config(config_path: Path) -> dict:
    """Load and validate YAML configuration."""

    # Load YAML
    with open(config_path) as f:
        config = yaml.safe_load(f)

    # Validate required fields
    if not isinstance(config, dict):
        raise ValueError("Configuration must be YAML dict")

    if 'fragments' not in config:
        raise ValueError("Missing required field: fragments")

    if 'output' not in config:
        raise ValueError("Missing required field: output")

    # Validate types
    if not isinstance(config['fragments'], list):
        raise ValueError("fragments must be list")

    if not config['fragments']:
        raise ValueError("fragments list is empty")

    if not isinstance(config['output'], str):
        raise ValueError("output must be string")

    if not config['output'].strip():
        raise ValueError("output is empty")

    # Validate optional fields
    if 'sources' in config and not isinstance(config['sources'], dict):
        raise ValueError("sources must be dict")

    if 'adjust_headers' in config and not isinstance(config['adjust_headers'], bool):
        raise ValueError("adjust_headers must be boolean")

    if 'separator' in config:
        valid_seps = {"---", "blank", "none"}
        if config['separator'] not in valid_seps:
            raise ValueError(f"separator must be one of {valid_seps}")

    if 'validate_mode' in config:
        valid_modes = {"strict", "warn"}
        if config['validate_mode'] not in valid_modes:
            raise ValueError(f"validate_mode must be one of {valid_modes}")

    return config
```

### Compose-time Validation (strict mode)

```python
def _validate_fragments(fragments: List[Path]) -> List[Path]:
    """Check all fragments exist before composition."""
    missing = [f for f in fragments if not f.exists()]
    if missing:
        raise FileNotFoundError(
            f"Missing fragments: {', '.join(str(p) for p in missing)}"
        )
    return fragments
```

---

## CLI Integration

### Configuration via CLI

**Primary method: YAML file**

```bash
claudeutils compose agents/compose.yaml
```

**Override output path**

```bash
claudeutils compose agents/compose.yaml --output dist/CLAUDE.md
```

**Override validation mode**

```bash
claudeutils compose agents/compose.yaml --validate warn
```

### Exit Codes

| Code | Meaning             | Example                      |
| ---- | ------------------- | ---------------------------- |
| 0    | Success             | Composition completed        |
| 1    | Configuration error | Invalid YAML, missing fields |
| 2    | Fragment error      | Missing file in strict mode  |
| 3    | Output error        | Cannot write file            |
| 4    | Argument error      | Invalid CLI flags            |

---

## Forward Compatibility

### Unknown Fields

The schema intentionally allows unknown fields (YAML anchor approach):

```yaml
# Future field (not yet implemented)
metadata:
  version: "1.0"
  author: "Project Team"

# Ignored by current parser, preserved if config rewritten
```

**Implementation**: Don't error on unknown fields, just ignore them.

### Future Extensions

Planned without schema breaking changes:

1. **Role templates** - `roles:` section with multiple definitions
2. **Fragment conditions** - Per-fragment include/exclude logic
3. **Variables** - Substitution pattern (planned for Phase 4)
4. **Metadata** - Per-fragment or document-level
5. **Output formats** - Support HTML, Markdown variants

---

## Summary

The YAML schema provides:

1. **Minimal required fields** - `fragments` and `output`
2. **Flexible composition** - Title, header adjustment, separators
3. **Path deduplication** - YAML anchors for DRY pattern
4. **Validation modes** - Strict (fail-fast) or warn (skip missing)
5. **Source mapping** - `sources` section for path organization
6. **Forward compatibility** - Unknown fields allowed for future extensions

The design balances:

- **Simplicity** - Most configs need only 2 required fields
- **Expressiveness** - Optional fields for advanced use cases
- **Maintainability** - Anchors reduce path duplication
- **Extensibility** - Schema allows new fields without breaking changes

This schema directly enables the composition model from design.md: local template + shared fragments, with explicit customization and no drift concept.
