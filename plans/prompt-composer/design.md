# Module System Design Document

- **Status**: Design decisions finalized, module extraction complete
- **Last Updated**: 2025-12-26
- **Design Authority**: Opus (claude-opus-4-5-20251101)
- **Design Review**: plans/prompt-composer/opus-review-tiering.md

---

## Executive Summary

Restructure agent instruction files from monolithic role files to composable module
system. Goals: reduce token costs (especially Opus planning output), enable reuse of
cross-cutting concerns, provide target-appropriate wording (strong vs weak models), and
maintain budget constraint of ≤150 total rules.

**Key innovation**: Semantic source files with tier hints + generated variants per model
class with `[RULE:Tn]` markers for budget tracking and composition.

---

## Requirements

### Core Constraints

- **Rule count limit**: ≤150 total user rules (Claude system prompt: ~50, leaving 150)
- **Token cost optimization**: Minimize Opus input/output tokens for planning work
- **Self-contained roles**: No plan/task-specific instructions in role files
- **Context caching**: Plans loaded by user, not referenced in "BEFORE STARTING"
  sections
- **Target-appropriate wording**: Concise for strong models, explicit for weak models

### Current System

**Files**:

- 6 roles: `planning.md`, `code.md`, `lint.md`, `refactor.md`, `execute.md`,
  `remember.md`
- 2 skills: `commit.md`, `handoff.md`
- 1 master: `CLAUDE.md` (project overview, communication patterns, tool batching)

**Terminology**:

- **Role file** (e.g., `planning.md`): Defines agent behavior mode
- **Plan artifact** (e.g., `PLAN.md`): Task instructions created by planning/refactor
  roles
- **Skill file**: Action-triggered rules (commit before git commit, handoff before
  session end)

**Current state**: All files generated by Opus. Prose-heavy for strong models, itemized
with ⚠️ symbols for weak models.

### Target State

- **Reusable modules**: Cross-cutting concerns (tool batching, checkpoint obedience,
  communication patterns)
- **Selective project context**: Planning needs full context, code needs data model
  only, lint/execute minimal
- **Priority tiering**: Rules distributed across document positions leveraging
  primacy/recency bias
- **Version control**: Both semantic sources and generated variants tracked
- **Rebuild tracking**: Makefile + sentinels keyed by model ID
- **Module sources**: Natural language, current Opus-generated files as initial sources

### Specific Requirements

1. **Remove "BEFORE STARTING" sections**: Plans loaded by user for context caching
2. **Factor checkpoint instructions**: Planning role inserts checkpoints in PLAN.md,
   code role obeys them
3. **Split project context**: Modules for overview, data model, commands (selective
   inclusion)
4. **Rebuild commit.md**: Currently haiku-optimized, needs semantic source
5. **CLAUDE.md scope**: Fallback for non-role-primed agents only (communication + tool
   batching)
6. **Role-specific recipes**: Include in role files; generic recipes in
   CLAUDE.md/README.md
7. **Different expansion needs**: Agent classes require different rule counts for same
   semantic module

---

## Verified Research Findings

### Rule Format

[Effect of Selection Format on LLM Performance (arXiv 2025)](https://arxiv.org/html/2503.06926):
Bullet points outperform prose for task adherence due to pretraining corpus
characteristics. However, connected ideas requiring context benefit from paragraph
format.

### Model Capabilities

[Claude Model Family (Anthropic)](https://www.anthropic.com/news/claude-3-family):

- **Haiku**: Needs precise, scoped, bite-sized tasks. Quick but shallow with elaborate
  prompts.
- **Sonnet**: Handles clear prompts well. Balanced for general tasks.
- **Opus**: Can handle and benefit from very detailed/complex prompts. Catches nuances
  others miss.

### Position Bias (Critical)

[Serial Position Effects of LLMs (2024)](https://arxiv.org/html/2406.15981v1): LLMs
exhibit **strong primacy bias** (beginning matters most) and recency bias. Middle
content has weakest influence ("lost in the middle" phenomenon).
[Primacy exploitation research](https://arxiv.org/html/2507.13949) confirms this
pattern.

**Implication**: Current `remember.md` states "recency bias means later content gets
more attention" - this is **incorrect**. Tier 1 (critical) rules should be at START
(primacy position), not end.

### Context Loading

[Effective Context Engineering for AI Agents (Anthropic)](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents):
LLMs only read explicitly provided context. No learned behavior to load additional
files.

**Implication**: Role-primed agents won't load CLAUDE.md unless explicitly instructed.
No wasted rule needed to prevent loading.

### 20/60/20 Tiering

User claims research basis.
[ResearchGate: The 20-60-20 Rule](https://www.researchgate.net/publication/270824843_The_20-60-20_rule)
found, but is organizational change management, not LLM prompting. Opus assessment:
treat as reasonable heuristic, not empirically validated for LLMs.

---

## Design Decisions

### 1. Module Taxonomy

**Cross-Cutting Modules** (universal behaviors):

- `communication.mod` - Stop patterns, unexpected state handling, wait for instruction
- `tool-batching.mod` - Parallel tool calls, efficiency patterns
- `checkpoint-obedience.mod` - Following plan checkpoints (factored from code/execute
  roles)

**Project Context Modules** (selective inclusion):

- `context-overview.mod` - Project purpose, architecture summary
- `context-datamodel.mod` - Key entities, relationships, schemas
- `context-commands.mod` - Build, test, deploy commands

**Workflow Modules** (role-specific behaviors):

- `tdd-cycle.mod` - Red-green-refactor methodology
- `plan-creation.mod` - Checkpoint insertion, plan structure
- `plan-adherence.mod` - Checkpoint following, scope discipline
- `code-quality.mod` - Testing requirements, PR standards
- `code-review.mod` - Review process, correctness checks, refactoring guidelines
- `memory-management.mod` - Documentation patterns, tiering rules

**Skill Modules** (on-demand, token-cost exempt):

- `commit.skill` - Git commit workflow
- `handoff.skill` - Agent transition protocol

**Rationale**: Separation enables selective composition. Cross-cutting modules apply
universally; project context splits allow planning roles to load full context while
lint/execute roles load minimal. Checkpoint factorization reduces duplication across
planning (INSERT) and code (OBEY) roles.

### 2. Format Recommendations

Based on research findings:

| Content Type       | Format               | Rationale                                               |
| ------------------ | -------------------- | ------------------------------------------------------- |
| Discrete rules     | Bullets              | arXiv 2025: bullets outperform prose for task adherence |
| Connected concepts | Prose paragraph      | Same research: linked ideas need cohesion               |
| Critical rules     | ⚠️-prefixed items     | Visual salience for weak models                         |
| Examples           | Indented code blocks | Pattern matching for all model classes                  |

**Position optimization** (serial position effects):

- **Tier 1 rules**: Document START (primacy bias)
- **Tier 3 rules**: Document END (recency bias)
- **Tier 2 rules**: Middle (weakest position, contains most rules)

**Format per module type**:

- Cross-cutting: Pure itemized (discrete behaviors)
- Workflow: Hybrid (conceptual intro + itemized rules)
- Context: Prose (connected project knowledge)
- Skills: Itemized with examples (procedural)

### 3. Adaptation Strategy

**Three-tier model class system**:

| Class    | Model Examples | Characteristics                    |
| -------- | -------------- | ---------------------------------- |
| Strong   | Opus           | Prose-tolerant, inference-capable  |
| Standard | Sonnet         | Clear prompts, moderate expansion  |
| Weak     | Haiku          | Explicit steps, ⚠️ markers required |

**Mechanism: Semantic source + generated variants**

```
agents/modules/src/tdd-cycle.semantic.md   # Version-controlled source
agents/modules/gen/tdd-cycle.strong.md    # Generated by Opus
agents/modules/gen/tdd-cycle.standard.md  # Generated by Opus
agents/modules/gen/tdd-cycle.weak.md      # Generated by Opus
```

**Rule Counting Mechanism**:

- Opus inserts `[RULE]` or `[RULE:T1]`/`[RULE:T2]`/`[RULE:T3]` markers during variant
  generation
- Script counts markers for budget validation
- Markers removed in final composed roles (clean agent context)
- No parsing ambiguity - Opus decides what constitutes a rule

**Target Rule Counts** (ranges, not ratios):

```yaml
# Semantic source frontmatter
target_rules:
  strong: 3-5
  standard: 8-12
  weak: 12-18
```

- Budget planning uses max of range
- Opus generates within range
- Exceeding range generates warning, not failure
- `expansion_sensitivity` guides author's range choices (not computed)

**Generation approach**:

- Semantic source contains tier hints via section groupings
  (Critical/Important/Preferred)
- Opus generates variants with tier markers `[RULE:T1]`, `[RULE:T2]`, `[RULE:T3]`
- Rule count targets specified as ranges in frontmatter
- Makefile tracks model ID for rebuild triggers
- Validation warns on range violations

**Rationale**: Marker-based counting is unambiguous (Opus defines rules, not heuristic
parser). Ranges provide budget predictability while giving Opus flexibility. Tier
markers enable proper distribution across primacy/middle/recency positions.

**Trade-off accepted**: Requires Opus for variant generation (LLM judgment task).

### 4. Configuration Schema

**Location**: `agents/roles/{role}.yaml` (per Opus recommendation)

```yaml
# agents/roles/planning.yaml
role: planning
target_class: strong  # strong|standard|weak
rule_budget: 45       # Role-specific cap

modules:
  - communication
  - tool-batching
  - plan-creation
  - tdd-cycle
  - context-overview
  - context-datamodel
  - context-commands

# Output structure
sections:
  - ROLE_IDENTITY       # Role definition
  - CRITICAL_RULES      # Tier 1 rules from all modules (primacy position)
  - GUIDELINES          # Tier 2 rules from all modules
  - PREFERENCES         # Tier 3 rules from all modules (recency position)
  - CONTEXT             # Project context (no tier markers)

# Budget overflow handling
overflow_strategy: warn
```

**Schema elements**:

- `target_class`: Determines which generated variant to include (strong/standard/weak)
- `rule_budget`: Per-role cap; script validates combined total ≤150
- `modules`: List of modules to include (all tiers from each module included)
- `sections`: Output structure template (tier→section mapping done by composer)
- `overflow_strategy`: Behavior when role exceeds budget (warn only)

**Tier assignment**: Modules contain tier markers (`[RULE:T1]`, `[RULE:T2]`,
`[RULE:T3]`). Composer extracts rules by tier and distributes to sections. Same tier
assignment across all variants - tier represents semantic criticality, not expansion
level.

### 5. Generation Pipeline

**Stage 1: Source Authoring (Manual)**

- Create/update `agents/modules/src/*.semantic.md`
- Track authoring model in frontmatter
- Include `expansion_sensitivity` and optional `weak_expansion_notes`

**Stage 2: Variant Generation (Opus, cached)**

- Input: semantic.md + target_class
- Output: `agents/modules/gen/*.{strong,standard,weak}.md`
- Trigger: source change OR model ID change
- Target rule count from frontmatter ranges
- Opus prompt: generate variant with tier markers (`[RULE:T1]`, etc.)
- Validation warns if count exceeds target range

**Stage 3: Role Composition (Script)**

- Input: `agents/roles/{role}.yaml` + generated variants
- Process:
  - Select variants by target_class
  - Extract rules by tier marker (T1/T2/T3)
  - Distribute to sections (CRITICAL_RULES/GUIDELINES/PREFERENCES)
  - Remove `[RULE:Tn]` markers from final output
  - Validate rule count (count markers, check ≤150)
- Output: `agents/role-{role}.next.md` (development), `agents/role-{role}.md`
  (production)

**Stage 4: Validation (Script)**

- Module rule count within target range (warn if exceeded)
- Role rule count ≤ budget (warn if exceeded)
- Combined rules ≤ 150 (warn if exceeded)
- Tier distribution ~20/60/20 (warn if >30% deviation)
- Required modules present
- No orphan modules (unused by any role)

**Makefile sentinel pattern**:

```makefile
agents/modules/gen/%.strong.md: agents/modules/src/%.semantic.md .model-id
    opus-generate --class=strong $< > $@

.model-id: FORCE
    echo $(OPUS_MODEL_ID) | cmp -s - $@ || echo $(OPUS_MODEL_ID) > $@
```

**Rationale**: Sentinel tracks model ID; regenerates when Anthropic releases new Opus
version. Both sources and generated files version-controlled (generated files rarely
change, valuable for review/diff).

### 6. Example Module Structure

**Semantic source format**:

```markdown
# agents/modules/src/checkpoint-obedience.semantic.md

---
author_model: claude-opus-4-5-20251101
semantic_type: workflow
target_rules:
  strong: 3-4
  standard: 8-10
  weak: 12-16
---

## Critical (Tier 1)

Agent must stop at every checkpoint in the plan. Do not proceed past checkpoint without
explicit instruction.

## Important (Tier 2)

Report completion status when reaching checkpoint. Describe what was completed and what
remains.

## Preferred (Tier 3)

Checkpoints may contain tool restrictions or output requirements. Honor these
constraints when resuming work.
```

**Generated weak variant**:

````markdown
# checkpoint-obedience.weak.md

[RULE:T1] ⚠️ STOP at every checkpoint marker in the plan [RULE:T1] ⚠️ DO NOT proceed
past a checkpoint without user instruction [RULE:T1] Wait for user to say "continue" or
provide new direction [RULE:T1] Do not assume continuation is implied

Checkpoint recognition patterns: [RULE:T1] Lines starting with `## Checkpoint` [RULE:T1]
Lines containing `[STOP]` marker [RULE:T1] Explicit "pause for review" instructions

[RULE:T2] Report completion status when reaching checkpoint [RULE:T2] Describe what was
completed [RULE:T2] Describe what work remains after checkpoint [RULE:T2] Ask user for
next steps explicitly

[RULE:T3] Honor checkpoint-specific tool restrictions [RULE:T3] Honor
checkpoint-specific output requirements [RULE:T3] Resume work only after checkpoint
constraints acknowledged

⚠️ Failure to stop at checkpoints causes scope creep and rework
```

---

## Implementation Status

### ✅ COMPLETED: Module Extraction

**Date**: 2025-12-26 (Opus planning phase)

**Deliverables**:

- 14 semantic source modules in `agents/modules/src/`
- Tier hints via section groupings (Critical/Important/Preferred)
- Target rule ranges in frontmatter
- Module inventory documented in `agents/modules/MODULE_INVENTORY.md`

**Modules extracted**:

- Cross-cutting: communication, tool-batching, checkpoint-obedience, plan-adherence
- Context: context-overview, context-datamodel, context-commands
- Workflow: tdd-cycle, plan-creation, code-quality, code-review, memory-management
- Skills: commit, handoff

**Directory structure**:

```
agents/
├── roles/                # Role configuration specs (Opus decision)
│   ├── planning.yaml
│   ├── code.yaml
│   ├── lint.yaml
│   ├── execute.yaml
│   ├── refactor.yaml
│   ├── review.yaml
│   └── remember.yaml
├── modules/
│   ├── src/              # 14 semantic sources
│   ├── gen/              # Generated variants
│   └── MODULE_INVENTORY.md
├── role-planning.md      # Generated roles (production)
├── role-planning.next.md # Development output (migration)
├── role-code.md
├── role-code.next.md
├── role-lint.md
├── role-execute.md
├── role-refactor.md
├── role-review.md
├── role-remember.md
├── rules-commit.md       # Skills
├── rules-handoff.md
└── CLAUDE.md

Note: .next.md files used during development to avoid overwriting existing roles.
After validation, .next.md renamed to .md and old files archived.
````

### TODO: Script Requirements

**Components needed**:

1. **Rule counter**: Count `[RULE]` and `[RULE:Tn]` markers in markdown
2. **Variant generator**: Invoke Opus with semantic source + target class
3. **Role composer**: Combine variants, extract by tier, remove markers
4. **Budget validator**: Check counts, tier distribution, warn on violations
5. **Makefile integration**: Sentinel-based rebuild on source/model changes

**Language**: Python (project standard), integrate with existing `uv` setup.

### TODO: Implementation Phases

**See**: `plans/prompt-composer/plan-outline.md` for detailed phase breakdown

1. Rule counter (Phase 1.2)
2. Variant generator (Phase 3.1-3.2)
3. Role composer (Phase 4.1-4.2)
4. Validation (Phase 4.3)
5. Makefile automation (Phase 5)
6. Role configs (Phase 6)
7. Side-by-side testing (Phase 8)

---

## Resolved Design Questions

See `plans/prompt-composer/opus-review-tiering.md` and Opus agent (a8ddc9f) for detailed
analysis.

1. **Rule tiering**: Hybrid B+D - tier markers in variants, tier hints in sources
2. **Rule counting**: Marker-based (`[RULE:Tn]`), not parsing
3. **Target counts**: Ranges in frontmatter, not computed ratios
4. **Validation**: Warnings only, specific thresholds per scenario
5. **Module granularity**: 14 modules appropriate
6. **Marker removal**: Simple regex, remove in final composed roles
7. **Skill handling**: Weak-only, no variants (on-demand loading)
8. **Overflow strategy**: Warn (never fail, never auto-regenerate)
9. **Config location**: `agents/roles/` - clear purpose, discoverable, matches project
   patterns
10. **Development naming**: `.next.md` suffix to avoid overwriting during development

---

## Design Decision Summary

| Decision                                            | Choice                                                      | Rationale                                                      |
| --------------------------------------------------- | ----------------------------------------------------------- | -------------------------------------------------------------- |
| Module granularity                                  | Semantic groupings, 14 modules                              | Enables meaningful composition; rule-level too fragmented      |
| Format authority                                    | Research-backed (bullets + position bias)                   | arXiv findings, serial position effects                        |
| Adaptation storage                                  | Semantic + generated variants                               | Version-controlled intent + cached adaptations                 |
| Rule counting                                       | Marker-based (`[RULE:Tn]`)                                  | Unambiguous; Opus defines rules, not parser heuristics         |
| Target counts                                       | Ranges in frontmatter                                       | Budget predictability + Opus flexibility within bounds         |
| Tier assignment                                     | Markers in variants, hints in sources                       | Enables proper distribution across primacy/middle/recency      |
| Tier semantics                                      | Same tier across all variants                               | Tier = criticality, not expansion level                        |
| Skill handling                                      | Weak-only, no variants                                      | On-demand loading; marginal token savings not worth complexity |
| CLAUDE.md scope                                     | Fallback only (communication + tool-batching)               | Role-primed agents skip it per research                        |
| Tier distribution                                   | Tier 1→start (primacy), Tier 3→end (recency), Tier 2→middle | Position bias exploitation                                     |
| Validation approach                                 | Warnings with thresholds, never fail                        | Iterative refinement, human-in-loop                            |
| Marker removal                                      | Final composition step (clean agent context)                | No pollution of agent context with internal markers            |
| Both sources and generated files version controlled | Enables review, diff, rollback                              | Generated files rarely change, valuable context                |

---

## References

- [Effect of Selection Format on LLM Performance](https://arxiv.org/html/2503.06926)
- [Claude Model Family](https://www.anthropic.com/news/claude-3-family)
- [Serial Position Effects of LLMs](https://arxiv.org/html/2406.15981v1)
- [Exploiting Primacy Effect](https://arxiv.org/html/2507.13949)
- [Effective Context Engineering for AI Agents](https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents)
- [ResearchGate: The 20-60-20 Rule](https://www.researchgate.net/publication/270824843_The_20-60-20_rule)

---

## Document History

| Date       | Change                                | Author               |
| ---------- | ------------------------------------- | -------------------- |
| 2025-12-21 | Initial design from Opus consultation | opus-4-5, sonnet-4-5 |
